
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum VehicleOwnerType {
  self
  company
  rented
}

enum DriverStatus {
  available
  on_route
  off_duty
}

enum JobStatus {
  pending
  in_progress
  completed
  cancelled
}

enum RouteType {
  fastest
  economy
  via_gas_station
}

model Driver {
  id                      String          @id @default(uuid()) @db.Uuid
  name                    String
  dob                     DateTime?       @db.Date
  photoUrl                String?         @map("photo_url")
  aadharNo                String?         @unique @map("aadhar_no")
  isAadharVerified        Boolean         @default(false) @map("is_aadhar_verified")
  aadhaarOtpReferenceId   String?         @map("aadhaar_otp_reference_id")
  aadhaarOtpGeneratedAt   DateTime?       @map("aadhaar_otp_generated_at")
  aadharCardFile          String?         @map("aadhar_card_file")
  aadharCardFileKey       String?         @map("aadhar_card_file_key")
  driverLicenseNo         String?         @unique @map("driver_license_no")
  isDriverLicenseVerified Boolean         @default(false) @map("is_driver_license_verified")
  driverLicenseFile       String?         @map("driver_license_file")
  driverLicenseFileKey    String?         @map("driver_license_file_key")
  panCardNo               String?         @unique @map("pan_card_no")
  isPanCardVerified       Boolean         @default(false) @map("is_pan_card_verified")
  panAadhaarLinkStatus    String?         @map("pan_aadhaar_link_status")
  panAadhaarLinkCheckedAt DateTime?       @map("pan_aadhaar_link_checked_at")
  panCardFile             String?         @map("pan_card_file")
  panCardFileKey          String?         @map("pan_card_file_key")

  vehicleOwnerType       VehicleOwnerType? @map("vehicle_owner_type")
  vehiclePlateNo         String?           @map("vehicle_plate_no")
  isVehiclePlateVerified Boolean           @default(false) @map("is_vehicle_plate_verified")
  insuranceNo            String?           @map("insurance_no")
  isInsuranceVerified    Boolean           @default(false) @map("is_insurance_verified")
  insuranceFile          String?           @map("insurance_file")
  insuranceFileKey       String?           @map("insurance_file_key")

  createdAt               DateTime        @default(now()) @map("created_at")
  updatedAt               DateTime        @updatedAt @map("updated_at")
  verifiedDriver          VerifiedDriver?

  email               String
  emailVerified       Boolean   @default(false) @map("email_verified")
  image               String?
  phoneNumber         String?   @unique @map("phone_number")
  phoneNumberVerified Boolean   @default(false) @map("phone_number_verified")
  sessions            Session[]
  accounts            Account[]
  status              DriverStatus  @default(available)
  jobs                Job[]
  
  // Location tracking relations
  currentLocation     DriverLocation?  @relation("CurrentLocation")
  locationHistory     LocationPoint[]  @relation("LocationHistory")

  @@map("users")
  @@unique([email])
}

model VerifiedDriver {
  driverId    String    @id @map("user_id") @db.Uuid
  isVerified  Boolean   @default(false) @map("is_verified")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  driver      Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("verified_users")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String   @db.Uuid
  user      Driver   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String    @db.Uuid
  user                  Driver    @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model AdminUser {
  id            String         @id @default(uuid()) @db.Uuid
  name          String
  email         String         @unique
  emailVerified Boolean        @default(false) @map("email_verified")
  image         String?        @map("profile_photo_url")
  sessions      AdminSession[]
  accounts      AdminAccount[]
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")




  @@map("admin_users")
}

model AdminSession {
  id        String    @id
  expiresAt DateTime
  token     String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  ipAddress String?
  userAgent String?
  userId    String    @db.Uuid @map("user_id")
  user      AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("admin_session")
}

model AdminAccount {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String    @db.Uuid @map("user_id")
  user                  AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("admin_account")
}

model AdminVerification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("admin_verification")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Job {
  id                String   @id @default(uuid()) @db.Uuid
  title             String
  weightKg          Int      @map("weight_kg")

  pickupAddress     String   @map("pickup_address")
  pickupLat         Decimal  @map("pickup_lat") @db.Decimal(9, 6)
  pickupLng         Decimal  @map("pickup_lng") @db.Decimal(9, 6)

  dropAddress       String   @map("drop_address")
  dropLat           Decimal  @map("drop_lat") @db.Decimal(9, 6)
  dropLng           Decimal  @map("drop_lng") @db.Decimal(9, 6)

  pickupAt          DateTime @map("pickup_at")
  dropWindowStartAt DateTime @map("drop_window_start_at")
  dropWindowEndAt   DateTime @map("drop_window_end_at")

  distanceMeters    Int      @map("distance_meters")
  durationSeconds   Int?     @map("duration_seconds")
  routeType         RouteType? @map("route_type")
  routeGeometry     Json?    @map("route_geometry")
  estimatedFuelCost Int?     @map("estimated_fuel_cost")
  status            JobStatus @default(pending)

  driverId          String?  @map("driver_id") @db.Uuid
  driver            Driver?  @relation(fields: [driverId], references: [id])
  invoices          Invoice[]

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Location tracking relations
  driverLocation    DriverLocation?
  locationPoints    LocationPoint[]
  
  // Package verification relations
  packageVerifications PackageVerification[]

  @@index([pickupAt])
  @@index([status])
  @@map("jobs")
}

// ============================================
// Package Verification Models
// ============================================

enum VerificationPhase {
  pickup
  delivery
}

model PackageVerification {
  id                String            @id @default(uuid()) @db.Uuid
  jobId             String            @map("job_id") @db.Uuid
  job               Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  phase             VerificationPhase
  
  // Driver-captured image
  capturedImageUrl  String            @map("captured_image_url")
  capturedImageKey  String?           @map("captured_image_key")
  
  // PatchCore API response data
  damagePercentage  Decimal           @map("damage_percentage") @db.Decimal(5, 2)
  anomalyDetected   Boolean           @map("anomaly_detected")
  threshold         Decimal           @db.Decimal(3, 2)
  heatmapImageUrl   String?           @map("heatmap_image_url")
  heatmapImageKey   String?           @map("heatmap_image_key")
  
  // Status
  passed            Boolean
  
  createdAt         DateTime          @default(now()) @map("created_at")

  @@index([jobId])
  @@map("package_verifications")
}

model Invoice {
  id                String            @id @default(uuid()) @db.Uuid
  invoiceNumber     String            @unique @map("invoice_number")
  invoiceDate       DateTime          @map("invoice_date")
  type              InvoiceType
  status            InvoiceStatus     @default(DRAFT)
  supplierName      String            @map("supplier_name")
  supplierGstin     String?           @map("supplier_gstin")
  supplierAddress   String            @map("supplier_address")
  supplierEmail     String?           @map("supplier_email")
  supplierPhone     String?           @map("supplier_phone")
  supplierIecCode   String?           @map("supplier_iec_code")
  buyerName         String            @map("buyer_name")
  buyerGstin        String?           @map("buyer_gstin")
  buyerAddress      String            @map("buyer_address")
  buyerEmail        String?           @map("buyer_email")
  buyerCountry      String?           @map("buyer_country")
  buyerEin          String?           @map("buyer_ein")
  placeOfSupply     String            @map("place_of_supply")
  subtotal          Decimal           @db.Decimal(12, 2)
  totalTax          Decimal           @map("total_tax") @db.Decimal(12, 2)
  grandTotal        Decimal           @map("grand_total") @db.Decimal(12, 2)
  totalInWords      String            @map("total_in_words")
  ewayBillNumber    String?           @map("eway_bill_number")
  lutNumber         String?           @map("lut_number")
  shippingBillNumber String?          @map("shipping_bill_number")
  portOfLoading     String?           @map("port_of_loading")
  terms             String?           @db.Text
  bankAccount       String?           @map("bank_account")
  bankIfsc          String?           @map("bank_ifsc")
  bankName          String?           @map("bank_name")
  qrCode            String?           @map("qr_code") @db.Text
  jobId             String?           @map("job_id") @db.Uuid
  job               Job?              @relation(fields: [jobId], references: [id])
  lineItems         InvoiceLineItem[]
  auditLogs         InvoiceAuditLog[]
  referenceInvoiceId String?         @map("reference_invoice_id") @db.Uuid
  referenceInvoice   Invoice?        @relation("AdjustmentReferences", fields: [referenceInvoiceId], references: [id])
  adjustments        Invoice[]       @relation("AdjustmentReferences")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  @@index([invoiceDate])
  @@index([status])
  @@map("invoices")
}

model InvoiceLineItem {
  id           String  @id @default(uuid()) @db.Uuid
  description  String
  hsnCode      String  @map("hsn_code")
  quantity     Decimal @db.Decimal(10, 3)
  rate         Decimal @db.Decimal(12, 2)
  discount     Decimal @default(0) @db.Decimal(12, 2)
  taxableValue Decimal @map("taxable_value") @db.Decimal(12, 2)
  cgstRate     Decimal @default(0) @map("cgst_rate") @db.Decimal(5, 2)
  cgstAmount   Decimal @default(0) @map("cgst_amount") @db.Decimal(12, 2)
  sgstRate     Decimal @default(0) @map("sgst_rate") @db.Decimal(5, 2)
  sgstAmount   Decimal @default(0) @map("sgst_amount") @db.Decimal(12, 2)
  igstRate     Decimal @default(0) @map("igst_rate") @db.Decimal(5, 2)
  igstAmount   Decimal @default(0) @map("igst_amount") @db.Decimal(12, 2)
  cessRate     Decimal @default(0) @map("cess_rate") @db.Decimal(5, 2)
  cessAmount   Decimal @default(0) @map("cess_amount") @db.Decimal(12, 2)
  invoiceId    String  @map("invoice_id") @db.Uuid
  invoice      Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_line_items")
}

model InvoiceAuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  action    String
  details   Json?
  invoiceId String   @map("invoice_id") @db.Uuid
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("invoice_audit_logs")
}

model CompanyGSTConfig {
  id          String   @id @default(uuid()) @db.Uuid
  companyName String   @map("company_name")
  gstin       String   @unique
  address     String
  email       String?
  phone       String?
  pan         String?
  iecCode     String?  @map("iec_code")
  bankName    String?  @map("bank_name")
  bankAccount String?  @map("bank_account")
  bankIfsc    String?  @map("bank_ifsc")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("company_gst_configs")
}

enum InvoiceType {
  TAX_INVOICE
  BILL_OF_SUPPLY
  DELIVERY_CHALLAN
  EXPORT_INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
}

enum InvoiceStatus {
  DRAFT
  PENDING
  ISSUED
  PAID
  VOIDED
  CANCELLED
}

enum TaxType {
  CGST
  SGST
  IGST
  UTGST
  CESS
}

enum DriverPhase {
  en_route_to_pickup
  at_pickup
  en_route_to_dropoff
  completed
}

// ============================================
// Real-Time Location Tracking Models
// ============================================

// Current driver location (latest position for fast lookups)
model DriverLocation {
  id         String   @id @default(uuid()) @db.Uuid
  jobId      String   @unique @map("job_id") @db.Uuid
  job        Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  driverId   String   @unique @map("driver_id") @db.Uuid
  driver     Driver   @relation("CurrentLocation", fields: [driverId], references: [id], onDelete: Cascade)
  
  latitude   Decimal  @db.Decimal(9, 6)
  longitude  Decimal  @db.Decimal(9, 6)
  speedMps   Decimal? @map("speed_mps") @db.Decimal(6, 2)
  heading    Int?     // Degrees 0-360
  routeGeometry Json? @map("route_geometry")
  driverPhase   DriverPhase @default(en_route_to_pickup) @map("driver_phase")
  pickupRouteGeometry Json? @map("pickup_route_geometry")
  
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([jobId])
  @@index([driverId])
  @@map("driver_locations")
}

// Complete path history - stores every location point
model LocationPoint {
  id         String   @id @default(uuid()) @db.Uuid
  jobId      String   @map("job_id") @db.Uuid
  job        Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  driverId   String   @map("driver_id") @db.Uuid
  driver     Driver   @relation("LocationHistory", fields: [driverId], references: [id], onDelete: Cascade)
  
  latitude   Decimal  @db.Decimal(9, 6)
  longitude  Decimal  @db.Decimal(9, 6)
  speedMps   Decimal? @map("speed_mps") @db.Decimal(6, 2)
  heading    Int?
  
  timestamp  DateTime @default(now())
  
  @@index([jobId, timestamp])
  @@index([driverId, timestamp])
  @@map("location_points")
}

// ============================================
// Warehouse Management Models
// ============================================

enum ProductCategory {
  electronics
  food
  apparel
  pharmaceuticals
  machinery
  raw_materials
  packaging
  other
}

enum BlockStatus {
  normal
  warning
  critical
  empty
}

model Warehouse {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  code      String   @unique
  address   String
  city      String
  workers   Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  floors    Floor[]

  @@map("warehouses")
}

model Floor {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  level       Int
  warehouseId String    @map("warehouse_id") @db.Uuid
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  blocks      Block[]
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([warehouseId])
  @@map("floors")
}

model Block {
  id          String          @id @default(uuid()) @db.Uuid
  name        String
  row         String
  column      Int
  capacity    Int
  floorId     String          @map("floor_id") @db.Uuid
  floor       Floor           @relation(fields: [floorId], references: [id], onDelete: Cascade)
  category    ProductCategory
  temperature Decimal?        @db.Decimal(4, 1)
  humidity    Int?
  products    Product[]
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@index([floorId])
  @@map("blocks")
}

model Product {
  id           String          @id @default(uuid()) @db.Uuid
  sku          String          @unique
  name         String
  quantity     Int
  category     ProductCategory
  boughtAt     Decimal         @map("bought_at") @db.Decimal(10, 2)
  currentPrice Decimal         @map("current_price") @db.Decimal(10, 2)
  expiryDate   DateTime?       @map("expiry_date")
  blockId      String          @map("block_id") @db.Uuid
  block        Block           @relation(fields: [blockId], references: [id], onDelete: Cascade)
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  @@index([blockId])
  @@index([sku])
  @@map("products")
}
