generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Auth & User Models
// ============================================

model Driver {
  id                      String               @id @default(uuid()) @db.Uuid
  name                    String
  dob                     DateTime?            @db.Date
  photoUrl                String?              @map("photo_url")
  aadharNo                String?              @unique @map("aadhar_no")
  isAadharVerified        Boolean              @default(false) @map("is_aadhar_verified")
  aadharCardFile          String?              @map("aadhar_card_file")
  driverLicenseNo         String?              @unique @map("driver_license_no")
  isDriverLicenseVerified Boolean              @default(false) @map("is_driver_license_verified")
  driverLicenseFile       String?              @map("driver_license_file")
  panCardNo               String?              @unique @map("pan_card_no")
  isPanCardVerified       Boolean              @default(false) @map("is_pan_card_verified")
  panCardFile             String?              @map("pan_card_file")
  createdAt               DateTime             @default(now()) @map("created_at")
  updatedAt               DateTime             @updatedAt @map("updated_at")
  email                   String               @unique
  emailVerified           Boolean              @default(false) @map("email_verified")
  image                   String?
  aadharCardFileKey       String?              @map("aadhar_card_file_key")
  driverLicenseFileKey    String?              @map("driver_license_file_key")
  panCardFileKey          String?              @map("pan_card_file_key")
  phoneNumber             String?              @unique @map("phone_number")
  phoneNumberVerified     Boolean              @default(false) @map("phone_number_verified")
  aadhaarOtpGeneratedAt   DateTime?            @map("aadhaar_otp_generated_at")
  aadhaarOtpReferenceId   String?              @map("aadhaar_otp_reference_id")
  insuranceFile           String?              @map("insurance_file")
  insuranceFileKey        String?              @map("insurance_file_key")
  insuranceNo             String?              @map("insurance_no")
  isInsuranceVerified     Boolean              @default(false) @map("is_insurance_verified")
  isVehiclePlateVerified  Boolean              @default(false) @map("is_vehicle_plate_verified")
  panAadhaarLinkCheckedAt DateTime?            @map("pan_aadhaar_link_checked_at")
  panAadhaarLinkStatus    String?              @map("pan_aadhaar_link_status")
  vehicleOwnerType        VehicleOwnerType?    @map("vehicle_owner_type")
  vehiclePlateNo          String?              @map("vehicle_plate_no")
  status                  DriverStatus         @default(available)
  accounts                Account[]
  currentLocation         DriverLocation?      @relation("CurrentLocation")
  jobs                    Job[]
  locationHistory         LocationPoint[]      @relation("LocationHistory")
  sessions                Session[]
  verifiedDriver          VerifiedDriver?
  walletAddress           String?              @map("wallet_address")
  baseSalary              Decimal              @default(20000) @map("base_salary") @db.Decimal(12, 2)
  salaryPayments          SalaryPayment[]
  fuelPaymentRequests     FuelPaymentRequest[]

  @@map("users")
}

model VerifiedDriver {
  driverId    String    @id @map("user_id") @db.Uuid
  isVerified  Boolean   @default(false) @map("is_verified")
  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")
  driver      Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("verified_users")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String   @db.Uuid
  user      Driver   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String    @db.Uuid
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  Driver    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model AdminUser {
  id                   String                @id @default(uuid()) @db.Uuid
  name                 String
  email                String                @unique
  emailVerified        Boolean               @default(false) @map("email_verified")
  image                String?               @map("profile_photo_url")
  walletAddress        String?               @map("wallet_address")
  encryptedWalletKey   String?               @map("encrypted_wallet_key")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  accounts             AdminAccount[]
  sessions             AdminSession[]
  notificationReceipts NotificationReceipt[]

  @@map("admin_users")
}

model AdminSession {
  id        String    @id
  expiresAt DateTime
  token     String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  ipAddress String?
  userAgent String?
  userId    String    @map("user_id") @db.Uuid
  user      AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("admin_session")
}

model AdminAccount {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String    @map("user_id") @db.Uuid
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("admin_account")
}

model AdminVerification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("admin_verification")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// ============================================
// Business Models (Jobs, Invoices, Chat)
// ============================================

model Job {
  id                   String                @id @default(uuid()) @db.Uuid
  title                String
  weightKg             Int                   @map("weight_kg")
  cargoName            String?               @map("cargo_name")
  cargoQuantity        Decimal?              @map("cargo_quantity") @db.Decimal(12, 2)
  cargoUnit            CargoUnit?            @map("cargo_unit")
  pickupAddress        String                @map("pickup_address")
  pickupLat            Decimal               @map("pickup_lat") @db.Decimal(9, 6)
  pickupLng            Decimal               @map("pickup_lng") @db.Decimal(9, 6)
  dropAddress          String                @map("drop_address")
  dropLat              Decimal               @map("drop_lat") @db.Decimal(9, 6)
  dropLng              Decimal               @map("drop_lng") @db.Decimal(9, 6)
  pickupAt             DateTime              @map("pickup_at")
  dropWindowStartAt    DateTime              @map("drop_window_start_at")
  dropWindowEndAt      DateTime              @map("drop_window_end_at")
  distanceMeters       Int                   @map("distance_meters")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  driverId             String?               @map("driver_id") @db.Uuid
  status               JobStatus             @default(pending)
  durationSeconds      Int?                  @map("duration_seconds")
  estimatedFuelCost    Int?                  @map("estimated_fuel_cost")
  routeGeometry        Json?                 @map("route_geometry")
  routeType            RouteType?            @map("route_type")
  chatThread           ChatThread?
  driverLocation       DriverLocation?
  invoices             Invoice[]
  driver               Driver?               @relation(fields: [driverId], references: [id])
  locationPoints       LocationPoint[]
  packageVerifications PackageVerification[]

  // Air shipments can optionally reference jobs for ground segments
  shipmentSegments ShipmentSegment[] @relation("JobShipmentSegments")

  // Multimodal fulfillment orchestration
  parentJobId         String?              @map("parent_job_id") @db.Uuid
  parentJob           Job?                 @relation("JobHierarchy", fields: [parentJobId], references: [id], onDelete: SetNull)
  childJobs           Job[]                @relation("JobHierarchy")
  fulfillmentPlans    FulfillmentPlan[]    @relation("JobFulfillmentPlans")
  fulfillmentSegments FulfillmentSegment[] @relation("FulfillmentSegmentJob")

  @@index([pickupAt])
  @@index([status])
  @@index([parentJobId])
  @@map("jobs")
}

// ============================================
// Multimodal Fulfillment Orchestration
// ============================================

model FulfillmentPlan {
  id              String                @id @default(uuid()) @db.Uuid
  masterJobId     String                @map("master_job_id") @db.Uuid
  masterJob       Job                   @relation("JobFulfillmentPlans", fields: [masterJobId], references: [id], onDelete: Cascade)
  status          FulfillmentPlanStatus @default(draft)
  objective       FulfillmentObjective  @default(balanced)
  selectedPlanKey String?               @map("selected_plan_key")
  options         Json?                 @map("options")
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  segments        FulfillmentSegment[]

  @@index([masterJobId, createdAt])
  @@index([status, createdAt])
  @@map("fulfillment_plans")
}

model FulfillmentSegment {
  id        String                   @id @default(uuid()) @db.Uuid
  planId    String                   @map("plan_id") @db.Uuid
  plan      FulfillmentPlan          @relation(fields: [planId], references: [id], onDelete: Cascade)
  sortOrder Int                      @default(0) @map("sort_order")
  mode      FulfillmentSegmentMode
  status    FulfillmentSegmentStatus @default(planned)
  planned   Json?                    @map("planned")

  // Optional links to executed entities
  jobId           String?        @map("job_id") @db.Uuid
  job             Job?           @relation("FulfillmentSegmentJob", fields: [jobId], references: [id], onDelete: SetNull)
  shipmentId      String?        @map("shipment_id") @db.Uuid
  shipment        Shipment?      @relation(fields: [shipmentId], references: [id], onDelete: SetNull)
  trainShipmentId String?        @map("train_shipment_id") @db.Uuid
  trainShipment   TrainShipment? @relation(fields: [trainShipmentId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([planId, sortOrder])
  @@index([jobId])
  @@index([shipmentId])
  @@index([trainShipmentId])
  @@map("fulfillment_segments")
}

model ChatThread {
  id        String        @id @default(uuid()) @db.Uuid
  jobId     String        @unique @map("job_id") @db.Uuid
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  messages  ChatMessage[]
  job       Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@map("chat_threads")
}

model ChatMessage {
  id             String         @id @default(uuid()) @db.Uuid
  threadId       String         @map("thread_id") @db.Uuid
  senderType     ChatSenderType @map("sender_type")
  senderAdminId  String?        @map("sender_admin_id") @db.Uuid
  senderDriverId String?        @map("sender_driver_id") @db.Uuid
  content        String
  createdAt      DateTime       @default(now()) @map("created_at")
  thread         ChatThread     @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@map("chat_messages")
}

model PackageVerification {
  id               String            @id @default(uuid()) @db.Uuid
  jobId            String            @map("job_id") @db.Uuid
  phase            VerificationPhase
  capturedImageUrl String            @map("captured_image_url")
  capturedImageKey String?           @map("captured_image_key")
  damagePercentage Decimal           @map("damage_percentage") @db.Decimal(5, 2)
  anomalyDetected  Boolean           @map("anomaly_detected")
  threshold        Decimal           @db.Decimal(3, 2)
  heatmapImageUrl  String?           @map("heatmap_image_url")
  heatmapImageKey  String?           @map("heatmap_image_key")
  passed           Boolean
  createdAt        DateTime          @default(now()) @map("created_at")
  job              Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@map("package_verifications")
}

model Invoice {
  id                  String               @id @default(uuid()) @db.Uuid
  invoiceNumber       String               @unique @map("invoice_number")
  invoiceDate         DateTime             @map("invoice_date")
  type                InvoiceType
  status              InvoiceStatus        @default(DRAFT)
  supplierName        String               @map("supplier_name")
  supplierGstin       String?              @map("supplier_gstin")
  supplierAddress     String               @map("supplier_address")
  supplierEmail       String?              @map("supplier_email")
  supplierPhone       String?              @map("supplier_phone")
  supplierIecCode     String?              @map("supplier_iec_code")
  buyerName           String               @map("buyer_name")
  buyerGstin          String?              @map("buyer_gstin")
  buyerAddress        String               @map("buyer_address")
  buyerEmail          String?              @map("buyer_email")
  buyerCountry        String?              @map("buyer_country")
  buyerEin            String?              @map("buyer_ein")
  placeOfSupply       String               @map("place_of_supply")
  subtotal            Decimal              @db.Decimal(12, 2)
  totalTax            Decimal              @map("total_tax") @db.Decimal(12, 2)
  grandTotal          Decimal              @map("grand_total") @db.Decimal(12, 2)
  totalInWords        String               @map("total_in_words")
  ewayBillNumber      String?              @map("eway_bill_number")
  lutNumber           String?              @map("lut_number")
  shippingBillNumber  String?              @map("shipping_bill_number")
  portOfLoading       String?              @map("port_of_loading")
  terms               String?
  bankAccount         String?              @map("bank_account")
  bankIfsc            String?              @map("bank_ifsc")
  bankName            String?              @map("bank_name")
  qrCode              String?              @map("qr_code")
  jobId               String?              @map("job_id") @db.Uuid
  referenceInvoiceId  String?              @map("reference_invoice_id") @db.Uuid
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  paidAmount          Decimal              @default(0) @map("paid_amount") @db.Decimal(12, 2)
  auditLogs           InvoiceAuditLog[]
  lineItems           InvoiceLineItem[]
  job                 Job?                 @relation(fields: [jobId], references: [id])
  referenceInvoice    Invoice?             @relation("AdjustmentReferences", fields: [referenceInvoiceId], references: [id])
  adjustments         Invoice[]            @relation("AdjustmentReferences")
  paymentTransactions PaymentTransaction[]
  fuelPaymentRequests FuelPaymentRequest[]

  @@index([invoiceDate])
  @@index([status])
  @@map("invoices")
}

model InvoiceLineItem {
  id           String  @id @default(uuid()) @db.Uuid
  description  String
  hsnCode      String  @map("hsn_code")
  quantity     Decimal @db.Decimal(10, 3)
  rate         Decimal @db.Decimal(12, 2)
  discount     Decimal @default(0) @db.Decimal(12, 2)
  taxableValue Decimal @map("taxable_value") @db.Decimal(12, 2)
  cgstRate     Decimal @default(0) @map("cgst_rate") @db.Decimal(5, 2)
  cgstAmount   Decimal @default(0) @map("cgst_amount") @db.Decimal(12, 2)
  sgstRate     Decimal @default(0) @map("sgst_rate") @db.Decimal(5, 2)
  sgstAmount   Decimal @default(0) @map("sgst_amount") @db.Decimal(12, 2)
  igstRate     Decimal @default(0) @map("igst_rate") @db.Decimal(5, 2)
  igstAmount   Decimal @default(0) @map("igst_amount") @db.Decimal(12, 2)
  cessRate     Decimal @default(0) @map("cess_rate") @db.Decimal(5, 2)
  cessAmount   Decimal @default(0) @map("cess_amount") @db.Decimal(12, 2)
  invoiceId    String  @map("invoice_id") @db.Uuid
  invoice      Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_line_items")
}

model InvoiceAuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  action    String
  details   Json?
  invoiceId String   @map("invoice_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_audit_logs")
}

model CompanyGSTConfig {
  id          String   @id @default(uuid()) @db.Uuid
  companyName String   @map("company_name")
  gstin       String   @unique
  address     String
  email       String?
  phone       String?
  pan         String?
  iecCode     String?  @map("iec_code")
  bankName    String?  @map("bank_name")
  bankAccount String?  @map("bank_account")
  bankIfsc    String?  @map("bank_ifsc")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("company_gst_configs")
}

// ============================================
// Notification Models
// ============================================

model NotificationEvent {
  id        String                @id @default(uuid()) @db.Uuid
  type      NotificationType
  title     String
  message   String
  actionUrl String?               @map("action_url")
  metadata  Json?
  createdAt DateTime              @default(now()) @map("created_at")
  receipts  NotificationReceipt[]

  @@index([createdAt])
  @@index([type])
  @@map("notification_events")
}

model NotificationReceipt {
  id         String            @id @default(uuid()) @db.Uuid
  userId     String            @map("user_id") @db.Uuid
  eventId    String            @map("event_id") @db.Uuid
  readAt     DateTime?         @map("read_at")
  archivedAt DateTime?         @map("archived_at")
  createdAt  DateTime          @default(now()) @map("created_at")
  event      NotificationEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user       AdminUser         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([userId, createdAt])
  @@index([userId, readAt])
  @@index([userId, archivedAt])
  @@map("notification_receipts")
}

// ============================================
// Tracking & History Models
// ============================================

model DriverLocation {
  id                  String      @id @default(uuid()) @db.Uuid
  jobId               String      @unique @map("job_id") @db.Uuid
  job                 Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  driverId            String      @unique @map("driver_id") @db.Uuid
  driver              Driver      @relation("CurrentLocation", fields: [driverId], references: [id], onDelete: Cascade)
  latitude            Decimal     @db.Decimal(9, 6)
  longitude           Decimal     @db.Decimal(9, 6)
  speedMps            Decimal?    @map("speed_mps") @db.Decimal(6, 2)
  heading             Int?
  updatedAt           DateTime    @updatedAt @map("updated_at")
  routeGeometry       Json?       @map("route_geometry")
  driverPhase         DriverPhase @default(en_route_to_pickup) @map("driver_phase")
  pickupRouteGeometry Json?       @map("pickup_route_geometry")

  @@index([jobId])
  @@index([driverId])
  @@map("driver_locations")
}

model LocationPoint {
  id        String   @id @default(uuid()) @db.Uuid
  jobId     String   @map("job_id") @db.Uuid
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  driverId  String   @map("driver_id") @db.Uuid
  driver    Driver   @relation("LocationHistory", fields: [driverId], references: [id], onDelete: Cascade)
  latitude  Decimal  @db.Decimal(9, 6)
  longitude Decimal  @db.Decimal(9, 6)
  speedMps  Decimal? @map("speed_mps") @db.Decimal(6, 2)
  heading   Int?
  timestamp DateTime @default(now())

  @@index([jobId, timestamp])
  @@index([driverId, timestamp])
  @@map("location_points")
}

// ============================================
// Warehouse Management Models
// ============================================

model Warehouse {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  code      String   @unique
  address   String
  city      String
  workers   Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  floors    Floor[]

  @@map("warehouses")
}

model Floor {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  level       Int
  warehouseId String    @map("warehouse_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  blocks      Block[]
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([warehouseId])
  @@map("floors")
}

model Block {
  id          String          @id @default(uuid()) @db.Uuid
  name        String
  row         String
  column      Int
  capacity    Int
  floorId     String          @map("floor_id") @db.Uuid
  category    ProductCategory
  temperature Decimal?        @db.Decimal(4, 1)
  humidity    Int?
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  floor       Floor           @relation(fields: [floorId], references: [id], onDelete: Cascade)
  products    Product[]

  @@index([floorId])
  @@map("blocks")
}

model Product {
  id           String          @id @default(uuid()) @db.Uuid
  sku          String          @unique
  name         String
  quantity     Int
  averageWeeklySales Int?      @map("average_weekly_sales")
  category     ProductCategory
  boughtAt     Decimal         @map("bought_at") @db.Decimal(10, 2)
  currentPrice Decimal         @map("current_price") @db.Decimal(10, 2)
  expiryDate   DateTime?       @map("expiry_date")
  blockId      String          @map("block_id") @db.Uuid
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")
  block        Block           @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@index([blockId])
  @@index([sku])
  @@map("products")
}

// ============================================
// Payments & Transactions
// ============================================

model PaymentTransaction {
  id              String   @id @default(uuid()) @db.Uuid
  invoiceId       String   @map("invoice_id") @db.Uuid
  amount          Decimal  @db.Decimal(12, 2)
  transactionHash String   @map("transaction_hash")
  payerAddress    String?  @map("payer_address")
  paymentMethod   String   @default("ESCROW") @map("payment_method")
  createdAt       DateTime @default(now()) @map("created_at")
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([transactionHash])
  @@map("payment_transactions")
}

model SalaryPayment {
  id              String   @id @default(uuid()) @db.Uuid
  driverId        String   @map("driver_id") @db.Uuid
  driver          Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  amount          Decimal  @db.Decimal(12, 2)
  transactionHash String   @map("transaction_hash")
  status          String   @default("PAID")
  paidAt          DateTime @default(now()) @map("paid_at")

  @@index([driverId])
  @@index([transactionHash])
  @@map("salary_payments")
}

// ============================================
// Air Shipments (Hybrid Ground + Air Tracking)
// ============================================

model Shipment {
  id            String         @id @default(uuid()) @db.Uuid
  referenceCode String         @unique @map("reference_code")
  status        ShipmentStatus @default(created)
  metadata      Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  segments            ShipmentSegment[]
  events              ShipmentEvent[]
  fulfillmentSegments FulfillmentSegment[]

  @@index([status, createdAt])
  @@map("shipments")
}

model ShipmentSegment {
  id String @id @default(uuid()) @db.Uuid

  shipmentId String   @map("shipment_id") @db.Uuid
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  type      ShipmentSegmentType
  sortOrder Int                 @default(0) @map("sort_order")

  // Ground segments can reference existing jobs (which already have driver tracking)
  jobId String? @map("job_id") @db.Uuid
  job   Job?    @relation("JobShipmentSegments", fields: [jobId], references: [id], onDelete: SetNull)

  // Air segment fields (prototype)
  carrier           String?
  carrierTrackingId String? @map("carrier_tracking_id")
  flightNumber      String? @map("flight_number")
  fromAirportIcao   String? @map("from_airport_icao")
  toAirportIcao     String? @map("to_airport_icao")
  icao24            String? @map("icao24")

  plannedDepartureAt DateTime? @map("planned_departure_at")
  plannedArrivalAt   DateTime? @map("planned_arrival_at")
  actualDepartureAt  DateTime? @map("actual_departure_at")
  actualArrivalAt    DateTime? @map("actual_arrival_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  events       ShipmentEvent[]
  airPositions AirPositionPoint[]

  @@index([shipmentId, sortOrder])
  @@index([jobId])
  @@index([carrierTrackingId])
  @@map("shipment_segments")
}

model ShipmentEvent {
  id String @id @default(uuid()) @db.Uuid

  shipmentId String   @map("shipment_id") @db.Uuid
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  segmentId String?          @map("segment_id") @db.Uuid
  segment   ShipmentSegment? @relation(fields: [segmentId], references: [id], onDelete: SetNull)

  type        ShipmentEventType
  title       String
  description String?           @db.Text

  locationName String?  @map("location_name")
  locationLat  Decimal? @map("location_lat") @db.Decimal(9, 6)
  locationLng  Decimal? @map("location_lng") @db.Decimal(9, 6)

  occurredAt DateTime @map("occurred_at")
  raw        Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([shipmentId, occurredAt])
  @@index([segmentId, occurredAt])
  @@index([type])
  @@map("shipment_events")
}

model AirPositionPoint {
  id String @id @default(uuid()) @db.Uuid

  segmentId String          @map("segment_id") @db.Uuid
  segment   ShipmentSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  timestamp          DateTime
  latitude           Decimal  @db.Decimal(9, 6)
  longitude          Decimal  @db.Decimal(9, 6)
  baroAltitudeMeters Decimal? @map("baro_altitude_meters") @db.Decimal(10, 2)
  velocityMps        Decimal? @map("velocity_mps") @db.Decimal(10, 2)
  heading            Decimal? @db.Decimal(6, 2)
  onGround           Boolean? @map("on_ground")
  source             String?  @map("source")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([segmentId, timestamp])
  @@map("air_position_points")
}

// ============================================
// Enums
// ============================================

enum VehicleOwnerType {
  self
  company
  rented
}

enum DriverStatus {
  available
  on_route
  off_duty
}

enum JobStatus {
  pending
  in_progress
  completed
  cancelled
}

enum RouteType {
  fastest
  economy
  via_gas_station
}

enum NotificationType {
  job
  driver
  packageVerification
  billing
  system
}

enum ChatSenderType {
  admin
  driver
}

enum VerificationPhase {
  pickup
  delivery
}

enum InvoiceType {
  TAX_INVOICE
  BILL_OF_SUPPLY
  DELIVERY_CHALLAN
  EXPORT_INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
  SALARY_SLIP
}

enum InvoiceStatus {
  DRAFT
  PENDING
  ISSUED
  PAID
  VOIDED
  CANCELLED
}

enum TaxType {
  CGST
  SGST
  IGST
  UTGST
  CESS
}

enum DriverPhase {
  en_route_to_pickup
  at_pickup
  en_route_to_dropoff
  completed
}

enum ProductCategory {
  electronics
  food
  apparel
  pharmaceuticals
  machinery
  raw_materials
  packaging
  other
}

enum BlockStatus {
  normal
  warning
  critical
  empty
}

enum ShipmentStatus {
  created
  in_transit
  delivered
  cancelled
  exception
}

enum ShipmentSegmentType {
  ground_pickup
  air
  ground_drop
}

enum ShipmentEventType {
  created
  carrier_update
  pickup_started
  pickup_completed
  air_departed
  air_arrived
  customs_clearance
  out_for_delivery
  delivered
  exception
}

enum FulfillmentPlanStatus {
  draft
  executing
  completed
  failed
  cancelled
}

enum FulfillmentObjective {
  balanced
  fastest
  cheapest
  revenue
}

enum FulfillmentSegmentMode {
  ground
  train
  air
}

enum FulfillmentSegmentStatus {
  planned
  in_progress
  completed
  failed
  cancelled
}

enum CargoUnit {
  kg
  ltr
  pcs
  box
  pkg
}

// ============================================
// Driver Fuel Payment Requests
// ============================================

model FuelPaymentRequest {
  id              String            @id @default(uuid()) @db.Uuid
  driverId        String            @map("driver_id") @db.Uuid
  driver          Driver            @relation(fields: [driverId], references: [id], onDelete: Cascade)
  amount          Decimal           @db.Decimal(12, 2)
  payeeAddress    String            @map("payee_address")
  payeeName       String?           @map("payee_name")
  transactionNote String?           @map("transaction_note")
  status          FuelPaymentStatus @default(pending)
  processedAt     DateTime?         @map("processed_at")
  invoiceId       String?           @map("invoice_id") @db.Uuid
  invoice         Invoice?          @relation(fields: [invoiceId], references: [id])
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@index([driverId, createdAt])
  @@index([status])
  @@map("fuel_payment_requests")
}

enum FuelPaymentStatus {
  pending
  approved
  rejected
}

// ============================================
// Train Shipments (Indian Railways)
// ============================================

enum TrainShipmentStatus {
  created
  waiting_for_train
  in_transit
  at_station
  delivered
  cancelled
}

model TrainShipment {
  id            String              @id @default(uuid()) @db.Uuid
  referenceCode String              @unique @map("reference_code")
  status        TrainShipmentStatus @default(created)

  // Package details
  packageName  String  @map("package_name")
  weightKg     Decimal @map("weight_kg") @db.Decimal(10, 2)
  packageCount Int     @default(1) @map("package_count")
  description  String?

  // Train details
  trainNumber String  @map("train_number")
  trainName   String  @map("train_name")
  coachType   String? @map("coach_type")
  pnr         String?

  // Route
  fromStationCode String @map("from_station_code")
  fromStationName String @map("from_station_name")
  toStationCode   String @map("to_station_code")
  toStationName   String @map("to_station_name")

  // Timing
  journeyDate  DateTime  @map("journey_date") @db.Date
  scheduledDep DateTime  @map("scheduled_dep")
  scheduledArr DateTime  @map("scheduled_arr")
  actualDep    DateTime? @map("actual_dep")
  actualArr    DateTime? @map("actual_arr")

  // Tracking
  currentStation String?   @map("current_station")
  currentLat     Decimal?  @map("current_lat") @db.Decimal(9, 6)
  currentLng     Decimal?  @map("current_lng") @db.Decimal(9, 6)
  delayMinutes   Int?      @map("delay_minutes")
  lastTrackedAt  DateTime? @map("last_tracked_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  events              TrainShipmentEvent[]
  positions           TrainPositionPoint[]
  fulfillmentSegments FulfillmentSegment[]

  @@index([status, journeyDate])
  @@index([trainNumber])
  @@map("train_shipments")
}

model TrainShipmentEvent {
  id         String        @id @default(uuid()) @db.Uuid
  shipmentId String        @map("shipment_id") @db.Uuid
  shipment   TrainShipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  type        String
  title       String
  description String?
  stationCode String?  @map("station_code")
  stationName String?  @map("station_name")
  occurredAt  DateTime @map("occurred_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([shipmentId, occurredAt])
  @@map("train_shipment_events")
}

model TrainPositionPoint {
  id         String        @id @default(uuid()) @db.Uuid
  shipmentId String        @map("shipment_id") @db.Uuid
  shipment   TrainShipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  stationCode   String    @map("station_code")
  stationName   String    @map("station_name")
  latitude      Decimal   @db.Decimal(9, 6)
  longitude     Decimal   @db.Decimal(9, 6)
  arrivalTime   DateTime? @map("arrival_time")
  departureTime DateTime? @map("departure_time")
  delay         String?
  platform      String?
  distanceKm    Int?      @map("distance_km")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([shipmentId, stationCode])
  @@index([shipmentId, createdAt])
  @@map("train_position_points")
}
